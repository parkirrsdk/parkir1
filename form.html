<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Tukar Shift / OFF</title>
  <link rel="stylesheet" href="style-form.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="menu-toggle" onclick="toggleMenu()" aria-label="Toggle Menu">‚ò∞</button>
  <div class="overlay" onclick="toggleMenu()"></div>

  <div class="form-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar" aria-label="Sidebar navigasi">
      <div class="sidebar-top">
        <div class="brand">
          <div class="logo">üìã</div>
          <div class="brand-text">
            <div class="brand-title">Shift App</div>
            <div class="brand-sub">Panel Input</div>
          </div>
        </div>
        <nav class="sidebar-nav">
          <a href="form.html" class="sidebar-link">Form Tukar Shift/Off</a>
          <a href="form-lembur.html" class="sidebar-link">Form Melemburkan</a>
          <a href="form-ganti-hari.html" class="sidebar-link">Form Pengantian Hari</a>
          <a href="index.html" class="sidebar-link">Dashboard</a>
        </nav>
      </div>
      <div class="sidebar-bottom">
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </aside>

    <!-- CONTENT -->
    <main class="content" role="main">
      <header class="content-header">
        <h1>Form Tukar Shift / OFF</h1>
        <div id="userInfo" class="user-info"></div>
        <p id="notif" class="notif-area" aria-live="polite"></p>
      </header>

      <section class="form-wrap">
        <form id="shiftForm" class="form-card">
          <h2>PIHAK 1</h2>
          <label>NAMA</label>
          <input type="text" name="nama1" placeholder="Masukkan nama lengkap" required>
          
          <label>JABATAN</label>
          <select name="jabatan1" required>
            <option value="">-- Pilih Jabatan --</option>
            <option value="Attenden">Attenden</option>
            <option value="Admin">Admin</option>
            <option value="Leader">Leader</option>
            <option value="CPM">CPM</option>
            <option value="Member">Member</option>
			<option value="IT">IT</option>
          </select>
          
          <label>SHIFT DARI</label>
          <select name="shift_dari1" required>
            <option value="">-- Pilih Shift --</option>
            <option value="Shift 1">Shift 1</option>
            <option value="Shift 2">Shift 2</option>
            <option value="Shift 3">Shift 3</option>
			<option value="-">-</option>   
          </select>
          
          <label>SHIFT MENJADI</label>
          <select name="shift_menjadi1" required>
            <option value="">-- Pilih Shift --</option>
            <option value="Shift 1">Shift 1</option>
            <option value="Shift 2">Shift 2</option>
            <option value="Shift 3">Shift 3</option>
			<option value="-">-</option> 
          </select>
          
          <label>JADWAL OFF</label>
          <input type="text" name="jadwal_off1" placeholder="Contoh Jum'at sabtu minggu">

          <h2>PIHAK 2</h2>
          <label>NAMA</label>
          <input type="text" name="nama2" placeholder="Masukkan nama lengkap" required>
          
          <label>JABATAN</label>
          <select name="jabatan2" required>
            <option value="">-- Pilih Jabatan --</option>
            <option value="Attenden">Attenden</option>
            <option value="Admin">Admin</option>
            <option value="Leader">Leader</option>
            <option value="CPM">CPM</option>
            <option value="Member">Member</option>
			<option value="IT">IT</option>
          </select>
          
          <label>SHIFT DARI</label>
          <select name="shift_dari2" required>
            <option value="">-- Pilih Shift --</option>
            <option value="Shift 1">Shift 1</option>
            <option value="Shift 2">Shift 2</option>
            <option value="Shift 3">Shift 3</option>
			<option value="-">-</option> 
          </select>
          
          <label>SHIFT MENJADI</label>
          <select name="shift_menjadi2" required>
            <option value="">-- Pilih Shift --</option>
            <option value="Shift 1">Shift 1</option>
            <option value="Shift 2">Shift 2</option>
            <option value="Shift 3">Shift 3</option>
			<option value="-">-</option> 
          </select>
          
          <label>JADWAL OFF</label>
          <input type="text" name="jadwal_off2" placeholder="Contoh Jum'at sabtu minggu">

          <h2>Detail Lain</h2>
          <label>TANGGAL TUKAR SHIFT / OFF</label>
          <input type="date" id="dateHelper" name="tanggal_shift" required>

          <div class="grid-4">
            <div>
              <label>HARI</label>
              <input type="text" id="hari" name="hari" readonly required>
            </div>
            <div>
              <label>TANGGAL</label>
              <input type="number" min="1" max="31" id="tanggal" name="tanggal" readonly required>
            </div>
            <div>
              <label>BULAN</label>
              <input type="number" min="1" max="12" id="bulan" name="bulan" readonly required>
            </div>
            <div>
              <label>TAHUN</label>
              <input type="number" min="2000" max="2100" id="tahun" name="tahun" readonly required>
            </div>
          </div>

          <label>ALASAN</label>
          <input type="text" name="alasan" placeholder="Jelaskan alasan tukar shift" required>
          
          <label>LEADER</label>
          <input type="text" name="leader" placeholder="Nama Leader yang menyetujui" required>

          <div class="form-actions">
            <button type="submit" class="btn-save">üíæ Simpan Data</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <!-- Mobile Menu Script -->
  <script>
    function toggleMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.overlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }
  </script>

  <!-- Firebase + app script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAT5F4_ZJr_kj0TaUM_0wwwknv3bZwDaog",
      authDomain: "shift-app-b73fd.firebaseapp.com",
      projectId: "shift-app-b73fd",
      storageBucket: "shift-app-b73fd.firebasestorage.app",
      messagingSenderId: "408848137650",
      appId: "1:408848137650:web:0ec055ed4d7524584cb8ab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
    if (!currentUser) window.location.href = "index.html";

    const userInfoDiv = document.getElementById("userInfo");
    if (userInfoDiv && currentUser) {
      userInfoDiv.innerText = `üë§ ${currentUser.role} - ${currentUser.username}`;
    }

    function logout() {
      localStorage.removeItem("currentUser");
      window.location.href = "index.html";
    }
    window.logout = logout;

    const role = currentUser.role;
    const dataLink = document.getElementById("dataLink");
    const downloadLink = document.getElementById("downloadLink");
    if (role === "Leader" || role === "Attendance") {
      if (dataLink) dataLink.style.display = "none";
      if (downloadLink) downloadLink.style.display = "none";
    }

    document.getElementById('shiftForm').onsubmit = async function(e) {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('.btn-save');
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Menyimpan...';
      
      const obj = { approve: false };
      [...form.elements].forEach(el => { if (el.name) obj[el.name] = el.value; });
      obj.createdBy = currentUser.username;
      obj.createdAt = new Date();

      const col = collection(db, "shiftData");
      const q1 = query(col, where("nama1", "==", obj.nama1), where("tanggal_shift", "==", obj.tanggal_shift));
      const q2 = query(col, where("nama2", "==", obj.nama2), where("tanggal_shift", "==", obj.tanggal_shift));
      const snap1 = await getDocs(q1);
      const snap2 = await getDocs(q2);

      if (!snap1.empty || !snap2.empty) {
        document.getElementById('notif').innerText = "‚ö†Ô∏è Data sudah diinput sebelumnya mohon cek di list data tukar shift/off!";
        document.getElementById('notif').classList.remove('success');
        document.getElementById('notif').classList.add('error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'üíæ Simpan Data';
        return;
      }

      try {
        await addDoc(col, obj);
        document.getElementById('notif').innerText = "‚úÖ Data berhasil disimpan!";
        document.getElementById('notif').classList.remove('error');
        document.getElementById('notif').classList.add('success');
        form.reset();
        setTimeout(() => {
          document.getElementById('notif').style.display = 'none';
        }, 5000);
      } catch (err) {
        console.error(err);
        document.getElementById('notif').innerText = "‚ùå Gagal simpan data!";
        document.getElementById('notif').classList.remove('success');
        document.getElementById('notif').classList.add('error');
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'üíæ Simpan Data';
    };
  </script>

  <!-- Auto isi tanggal -->
  <script>
    function isiTanggalOtomatis(dateInputId, hariId, tanggalId, bulanId, tahunId) {
      const dateInput = document.getElementById(dateInputId);
      dateInput.addEventListener("change", function () {
        if (!this.value) return;
        const d = new Date(this.value);
        const namaHari = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
        document.getElementById(hariId).value = namaHari[d.getDay()];
        document.getElementById(tanggalId).value = d.getDate();
        document.getElementById(bulanId).value = d.getMonth() + 1;
        document.getElementById(tahunId).value = d.getFullYear();
      });
    }
    isiTanggalOtomatis("dateHelper","hari","tanggal","bulan","tahun");
  </script>
</body>
</html>
