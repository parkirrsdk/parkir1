<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>List Data Ganti Hari</title>
  <link rel="stylesheet" href="style-listData.css">
  <style>
     /* Sedikit gaya untuk pagination */
    .pagination-controls { margin: 12px 0; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .pagination-controls select, .pagination-controls button { padding:6px 8px; }

    /* Button styles agar Prev/Next terlihat jelas */
    .pagination-controls button {
      background-color: #0d6efd; /* biru yang jelas */
      color: #ffffff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      transition: background-color 0.15s ease, transform 0.06s ease;
      cursor: pointer;
    }
    .pagination-controls button:hover:not(:disabled) {
      background-color: #0b5ed7;
      transform: translateY(-1px);
    }

    /* Saat disabled: tetap gunakan warna agar tidak terlihat abu-abu, namun beri indikasi non-interaktif */
    .pagination-controls button:disabled {
      opacity: 0.8;               /* sedikit reduksi, tapi tidak terlalu abu-abu */
      cursor: not-allowed;
      background-color: #0d6efd; /* sama warna sehingga tetap terlihat */
      color: #ffffff;
      box-shadow: none;
      transform: none;
    }

    .page-info { margin-left:8px; font-size:14px; color:#333; }
  </style>
</head>
<body>
  <div class="container">
    <h1>List Data Ganti Hari</h1>

    <div class="filter-section">
      <input type="text" id="searchInput" placeholder="ðŸ” Cari data..." onkeyup="currentPage=1; filterTable()">
      <select id="filterApprove" onchange="currentPage=1; filterTable()">
        <option value="">Semua Status</option>
        <option value="Approved">Approved</option>
        <option value="Pending">Pending</option>
        <option value="Rejected">Rejected</option>
      </select>
      <input type="date" id="filterTanggal" onchange="currentPage=1; filterTable()" style="margin-left:10px; padding:5px;">
    </div>

    <button id="deleteSelected" style="margin:10px 0; display:none;" onclick="deleteSelectedRows()">Delete Selected</button>
    <div class="table-responsive">
      <table id="dataTable" class="styled-table">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)" /></th>
            <th>No</th>
            <th>Nama</th>
            <th>Jabatan</th>
            <th>Alasan</th>
            <th>Tanggal</th>
            <th>Tanggal Pengganti Hari</th>
            <th>Status Approve</th>
            <th>Status Reject</th>
            <th>Reason</th>
            <th>User Approve</th>
            <th>Tanggal Approve</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-controls">
      <label>Rows per page:
        <select id="pageSize" onchange="currentPage=1; filterTable()">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="50">50</option>
          <option value="60">60</option>
          <option value="70">70</option>
          <option value="80">80</option>
          <option value="90">90</option>
          <option value="100">100</option>
        </select>
      </label>
      <div id="pagination"></div>
    </div>

    <div class="nav-links">
      <a href="download.html">Download Excel</a>
      <a href="index.html">Dashboard</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>

    <script>
      function logout() {
        localStorage.removeItem("currentUser");
        alert("Anda berhasil logout!");
        window.location.href = "login.html";
      }
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAT5F4_ZJr_kj0TaUM_0wwwknv3bZwDaog",
        authDomain: "shift-app-b73fd.firebaseapp.com",
        projectId: "shift-app-b73fd",
        storageBucket: "shift-app-b73fd.firebasestorage.app",
        messagingSenderId: "408848137650",
        appId: "1:408848137650:web:0ec055ed4d7524584cb8ab"
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
      const role = currentUser ? currentUser.role : "";

      function dateValueGanti(d) {
        const y = Number(d?.tahun_ganti);
        const m = Number(d?.bulan_ganti);
        const day = Number(d?.tanggal_ganti);
        if (!y || !m || !day) return null;
        return new Date(y, m - 1, day).getTime();
      }

      window.currentPage = 1;

      async function renderTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';

        const querySnapshot = await getDocs(collection(db, "gantiHariData"));
        let i = 1;
        const rows = [];
        querySnapshot.forEach(docSnap => {
          const d = docSnap.data();
          rows.push({ id: docSnap.id, ...d });
        });

        rows.sort((a, b) => {
          const aPending = !a.approve && !a.reject;
          const bPending = !b.approve && !b.reject;
          if (aPending && !bPending) return -1;
          if (!aPending && bPending) return 1;

          const da = dateValueGanti(a);
          const dbv = dateValueGanti(b);
          if (da === null && dbv === null) return 0;
          if (da === null) return 1;
          if (dbv === null) return -1;
          return da - dbv;
        });

        rows.forEach(d => {
          let approvers = [];
          if (d.leaderApprove && d.leaderBy) approvers.push(d.leaderBy);
          if (d.adminApprove && d.adminBy) approvers.push(d.adminBy);
          const approvedUsers = approvers.length > 0 ? approvers.join(", ") : "-";

          let approveDates = [];
          if (d.leaderApproveDate) approveDates.push(`Leader: ${d.leaderApproveDate}`);
          if (d.adminApproveDate) approveDates.push(`Admin: ${d.adminApproveDate}`);
          const approveDateText = approveDates.length > 0 ? approveDates.join("<br>") : "-";

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${role === "Superuser" ? `<input type="checkbox" class="row-checkbox" data-id="${d.id}" onchange="updateDeleteBtn()">` : ""}</td>
            <td>${i++}</td>
            <td>${d.nama}</td>
            <td>${d.jabatan}</td>
            <td>${d.dikarenakan}</td>
            <td>${d.hari_awal || ""}, ${d.tanggal_awal || ""}-${d.bulan_awal || ""}-${d.tahun_awal || ""}</td>
            <td>${d.hari_ganti || ""}, ${d.tanggal_ganti || ""}-${d.bulan_ganti || ""}-${d.tahun_ganti || ""}</td>
            <td><span class="badge ${d.approve ? 'approved' : 'pending'}">${d.approve ? "Approved" : "Pending"}</span></td>
            <td><span class="badge ${d.reject ? 'rejected' : 'pending'}">${d.reject ? "Rejected" : "-"}</span></td>
            <td>${d.reason || "-"}</td>
            <td>${approvedUsers}</td>
            <td>${approveDateText}</td>
            <td>${role === "Superuser" ? `<button class="delete" onclick="deleteData('${d.id}')">Delete</button>` : ""}</td>
          `;
          tbody.appendChild(tr);
        });
        updateDeleteBtn();
        filterTable();
      }

      window.deleteData = async function (id) {
        if (confirm("Yakin ingin menghapus data ini?")) {
          await deleteDoc(doc(db, "gantiHariData", id));
          alert("Data telah dihapus!");
          renderTable();
        }
      };

      window.deleteSelectedRows = async function () {
        const checkboxes = document.querySelectorAll(".row-checkbox:checked");
        if (checkboxes.length === 0) return;
        if (!confirm('Yakin ingin menghapus data terpilih?')) return;
        for (let c of checkboxes) {
          const id = c.getAttribute('data-id');
          await deleteDoc(doc(db, "gantiHariData", id));
        }
        alert("Data terpilih telah dihapus!");
        renderTable();
      };

      window.toggleSelectAll = function (all) {
        const checkboxes = document.querySelectorAll(".row-checkbox");
        checkboxes.forEach(c => {
          const tr = c.closest('tr');
          if (!tr.style.display || tr.style.display === "") {
            c.checked = all.checked;
          }
        });
        updateDeleteBtn();
      };

      window.updateDeleteBtn = function () {
        const count = document.querySelectorAll('.row-checkbox:checked').length;
        document.getElementById("deleteSelected").style.display = (count > 0) ? "inline-block" : "none";
        const all = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll(".row-checkbox");
        const shownCheckboxes = Array.from(checkboxes).filter(c => {
          const tr = c.closest('tr');
          return tr && (!tr.style.display || tr.style.display === "");
        });
        all.checked = shownCheckboxes.length > 0 && shownCheckboxes.every(c => c.checked);
      };

      renderTable();
    </script>

    <script>
      function renderPagination(totalMatched) {
        const pageSize = Number(document.getElementById('pageSize').value);
        const totalPages = Math.max(1, Math.ceil(totalMatched / pageSize));
        if (window.currentPage > totalPages) window.currentPage = totalPages;
        const paginationEl = document.getElementById('pagination');
        const prevDisabled = window.currentPage <= 1 ? 'disabled' : '';
        const nextDisabled = window.currentPage >= totalPages ? 'disabled' : '';
        paginationEl.innerHTML = `
          <button onclick="changePage(-1)" ${prevDisabled}>Prev</button>
          <span class="page-info">Halaman ${window.currentPage} dari ${totalPages}</span>
          <button onclick="changePage(1)" ${nextDisabled}>Next</button>
        `;
      }

      function changePage(delta) {
        const pageSize = Number(document.getElementById('pageSize').value);
        const trs = Array.from(document.querySelectorAll("#dataTable tbody tr"));
        const matchedCount = trs.filter(tr => tr.dataset.matched === '1').length;
        const totalPages = Math.max(1, Math.ceil(matchedCount / pageSize));
        window.currentPage = Math.min(Math.max(1, window.currentPage + delta), totalPages);
        filterTable();
      }

      function filterTable() {
        let approveFilter = document.getElementById("filterApprove").value.toLowerCase();
        let tanggalFilter = document.getElementById("filterTanggal").value;
        let input = document.getElementById("searchInput").value.toLowerCase();
        let trs = Array.from(document.querySelectorAll("#dataTable tbody tr"));

        trs.forEach(tr => {
          let tds = tr.getElementsByTagName("td");
          let show = true;

          if (input && !Array.from(tds).some(td => td.innerText.toLowerCase().includes(input))) {
            show = false;
          }
          if (approveFilter) {
            let statusText = tds[7]?.innerText.toLowerCase() || "";
            let rejectText = tds[8]?.innerText.toLowerCase() || "";
            if (approveFilter === "approved" && !statusText.includes("approved")) show = false;
            if (approveFilter === "pending" && !(statusText.includes("pending") || rejectText.includes("-"))) show = false;
            if (approveFilter === "rejected" && !rejectText.includes("rejected")) show = false;
          }
          if (tanggalFilter) {
            let tanggalText = tds[6]?.innerText || "";
            let match = tanggalText.match(/\d{1,2}-\d{1,2}-\d{4}/);
            if (match) {
              let [d, m, y] = match[0].split("-");
              let formatted = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
              if (formatted !== tanggalFilter) show = false;
            } else {
              show = false;
            }
          }
          tr.dataset.matched = show ? '1' : '0';
          tr.style.display = 'none';
        });

        const pageSize = Number(document.getElementById('pageSize').value);
        const matchedTrs = trs.filter(tr => tr.dataset.matched === '1');
        const totalMatched = matchedTrs.length;
        const totalPages = Math.max(1, Math.ceil(totalMatched / pageSize));
        if (window.currentPage > totalPages) window.currentPage = totalPages;
        const start = (window.currentPage - 1) * pageSize;
        const end = start + pageSize;
        matchedTrs.forEach((tr, idx) => {
          if (idx >= start && idx < end) tr.style.display = '';
          else tr.style.display = 'none';
        });

        renderPagination(totalMatched);
        if (window.updateDeleteBtn) window.updateDeleteBtn();
      }
    </script>

  </div>
</body>
</html>
