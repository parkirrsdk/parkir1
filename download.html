<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Download Excel Approve</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      max-width: 600px;
      width: 100%;
      padding: 40px 30px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      color: #374151;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    label::before {
      content: 'üìÖ';
      font-size: 18px;
    }

    input[type="date"] {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s ease;
      background: #f9fafb;
    }

    input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    .button-group {
      margin-top: 32px;
    }

    #downloadExcel {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    #downloadExcel::before {
      content: '‚¨áÔ∏è';
      font-size: 20px;
    }

    #downloadExcel:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
    }

    #downloadExcel:active {
      transform: translateY(-1px);
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, #e5e7eb, transparent);
      margin: 32px 0;
    }

    .nav-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 24px;
    }

    .nav-links a {
      background: #f3f4f6;
      padding: 12px 16px;
      border-radius: 10px;
      color: #667eea;
      font-weight: 600;
      text-decoration: none;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      font-size: 14px;
    }

    .nav-links a:hover {
      background: #e0f2fe;
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .info-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 24px;
      font-size: 13px;
      color: #92400e;
    }

    .info-box::before {
      content: 'üí° ';
      font-size: 16px;
    }

    .date-preview {
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 10px;
      padding: 16px;
      margin-top: 20px;
      text-align: center;
      font-size: 13px;
      color: #6b7280;
      display: none;
    }

    .date-preview.active {
      display: block;
    }

    .date-preview strong {
      color: #374151;
      font-size: 15px;
    }

    /* Loading State */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 24px 20px;
        border-radius: 16px;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 8px;
      }

      .subtitle {
        font-size: 13px;
        margin-bottom: 24px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      input[type="date"] {
        padding: 12px 14px;
        font-size: 14px;
      }

      #downloadExcel {
        padding: 14px 20px;
        font-size: 15px;
      }

      .nav-links {
        grid-template-columns: 1fr;
      }

      .nav-links a {
        padding: 12px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 20px 16px;
      }

      h1 {
        font-size: 22px;
      }

      .info-box {
        font-size: 12px;
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Download Data Approved</h1>
    <p class="subtitle">Download data yang sudah di-approve dalam format Excel</p>

    <div class="info-box">
      <strong>Info:</strong> Pilih rentang tanggal untuk mendownload data yang sudah disetujui dari semua kategori (Shift, Lembur, dan Ganti Hari).
    </div>

    <div class="form-group">
      <label for="filterStart">Tanggal Mulai</label>
      <input type="date" id="filterStart" required>
    </div>

    <div class="form-group">
      <label for="filterEnd">Tanggal Sampai</label>
      <input type="date" id="filterEnd" required>
    </div>

    <div class="date-preview" id="datePreview">
      Periode: <strong id="previewText">-</strong>
    </div>

    <div class="button-group">
      <button id="downloadExcel">Download Excel</button>
    </div>

    <div class="divider"></div>

    <div class="nav-links">
      <a href="index.html">üè† Dashboard</a>
      <a href="list-approve.html">‚úÖ List Approve</a>
      <a href="list-data.html">üìã List Data</a>
      <a href="#" onclick="logout(); return false;">üö™ Logout</a>
    </div>
  </div>

  <div class="loading" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    function logout() {
      localStorage.removeItem("currentUser");
      alert("Anda berhasil logout!");
      window.location.href = "login.html";
    }

    // Date preview
    const startInput = document.getElementById('filterStart');
    const endInput = document.getElementById('filterEnd');
    const datePreview = document.getElementById('datePreview');
    const previewText = document.getElementById('previewText');

    function updatePreview() {
      const start = startInput.value;
      const end = endInput.value;
      if (start && end) {
        datePreview.classList.add('active');
        previewText.textContent = `${start} sampai ${end}`;
      } else {
        datePreview.classList.remove('active');
      }
    }

    startInput.addEventListener('change', updatePreview);
    endInput.addEventListener('change', updatePreview);
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAT5F4_ZJr_kj0TaUM_0wwwknv3bZwDaog",
      authDomain: "shift-app-b73fd.firebaseapp.com",
      projectId: "shift-app-b73fd",
      storageBucket: "shift-app-b73fd.firebasestorage.app",
      messagingSenderId: "408848137650",
      appId: "1:408848137650:web:0ec055ed4d7524584cb8ab"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Helper: buat ISO date "YYYY-MM-DD" dari berbagai sumber
    function toISOFromParts(year, month, day) {
      if (year == null || month == null || day == null) return null;
      const y = String(year).padStart(4, "0");
      const m = String(month).padStart(2, "0");
      const d = String(day).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function isoDateFromValue(val) {
      if (!val && val !== 0) return null;
      if (typeof val === "object" && typeof val.toDate === "function") {
        const dt = val.toDate();
        if (!isNaN(dt)) return dt.toISOString().slice(0,10);
        return null;
      }
      if (val instanceof Date) {
        if (!isNaN(val)) return val.toISOString().slice(0,10);
        return null;
      }
      if (typeof val === "string") {
        if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
        const parsed = new Date(val);
        if (!isNaN(parsed)) return parsed.toISOString().slice(0,10);
        return null;
      }
      if (typeof val === "number") {
        const dt = new Date(val);
        if (!isNaN(dt)) return dt.toISOString().slice(0,10);
      }
      return null;
    }

    document.getElementById('downloadExcel').onclick = async function() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      
      try {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        if (!start || !end) {
          alert("‚ùå Masukkan tanggal mulai dan sampai.");
          return;
        }

        loadingOverlay.classList.add('active');

        const startISO = start;
        const endISO = end;

        // ===== SHIFT DATA =====
        const shiftData = [];
        const shiftSnap = await getDocs(collection(db, "shiftData"));
        shiftSnap.forEach(docSnap => {
          const d = docSnap.data() || {};
          let tanggalShiftISO = isoDateFromValue(d.tanggal_shift) || isoDateFromValue(d.tanggal) || toISOFromParts(d.tahun, d.bulan, d.tanggal);
          if (!tanggalShiftISO) {
            console.warn(`shiftData doc ${docSnap.id} tidak punya tanggal yang bisa diparse.`);
          }

          if (d.approve && tanggalShiftISO && tanggalShiftISO >= startISO && tanggalShiftISO <= endISO) {
            shiftData.push({
              "Nama 1": d.nama1 || d.nama || "",
              "Nama 2": d.nama2 || "",
              "Jabatan 1": d.jabatan1 || d.jabatan || "",
              "Jabatan 2": d.jabatan2 || "",
              "Shift Dari 1": d.shift_dari1 || d.shift_dari || "",
              "Shift Menjadi 1": d.shift_menjadi1 || d.shift_menjadi || "",
              "Tukar Off 1": d.jadwal_off1 || d.tukar_off || "",
              "Shift Dari 2": d.shift_dari2 || "",
              "Shift Menjadi 2": d.shift_menjadi2 || "",
              "Tukar Off 2": d.jadwal_off2 || "",
              "Leader": d.leader || "",
              "Tanggal Tukar Shift": tanggalShiftISO,
              "Hari": d.hari || "",
              "Tanggal": d.tanggal || "",
              "Bulan": d.bulan || "",
              "Tahun": d.tahun || "",
              "Alasan": d.alasan || d.reason || "",
              "User Approve": d.approvedBy || d.approver || "-"
            });
          }
        });

        // ===== LEMBUR DATA =====
        const lemburData = [];
        const lemburSnap = await getDocs(collection(db, "lemburData"));
        lemburSnap.forEach(docSnap => {
          const d = docSnap.data() || {};
          let tanggalISO = isoDateFromValue(d.tanggal) || isoDateFromValue(d.tanggal_lembur) || toISOFromParts(d.tahun, d.bulan, d.tanggal);
          if (!tanggalISO) {
            console.warn(`lemburData doc ${docSnap.id} tidak punya tanggal yang bisa diparse.`);
          }

          if (d.approve && tanggalISO && tanggalISO >= startISO && tanggalISO <= endISO) {
            lemburData.push({
              "Nama": d.nama || "",
              "Jabatan": d.jabatan || "",
              "Shift": d.shift || "",
              "Dilemburkan Oleh": d.dilemburkan_oleh || "",
              "Tanggal": `${d.hari || ""}${d.hari ? ", " : ""}${d.tanggal || ""}${d.tanggal ? "-" : ""}${d.bulan || ""}${d.bulan ? "-" : ""}${d.tahun || ""}`.replace(/(^, |--|-$)/g, ""),
              "TanggalISO": tanggalISO || "",
              "User Approve": d.approvedBy || "-"
            });
          }
        });

        // ===== GANTI HARI DATA =====
        const gantiHariData = [];
        const gantiHariSnap = await getDocs(collection(db, "gantiHariData"));
        gantiHariSnap.forEach(docSnap => {
          const d = docSnap.data() || {};
          let tanggalAwalISO = isoDateFromValue(d.tanggal_awal) || toISOFromParts(d.tahun_awal, d.bulan_awal, d.tanggal_awal);
          if (!tanggalAwalISO) {
            console.warn(`gantiHariData doc ${docSnap.id} tidak punya tanggal_awal yang bisa diparse.`);
          }

          if (d.approve && tanggalAwalISO && tanggalAwalISO >= startISO && tanggalAwalISO <= endISO) {
            gantiHariData.push({
              "Nama": d.nama || "",
              "Jabatan": d.jabatan || "",
              "Alasan": d.dikarenakan || "",
              "Tanggal Awal": `${d.hari_awal || ""}${d.hari_awal ? ", " : ""}${d.tanggal_awal || ""}${d.tanggal_awal ? "-" : ""}${d.bulan_awal || ""}${d.bulan_awal ? "-" : ""}${d.tahun_awal || ""}`.replace(/(^, |--|-$)/g, ""),
              "Tanggal Ganti": `${d.hari_ganti || ""}${d.hari_ganti ? ", " : ""}${d.tanggal_ganti || ""}${d.tanggal_ganti ? "-" : ""}${d.bulan_ganti || ""}${d.bulan_ganti ? "-" : ""}${d.tahun_ganti || ""}`.replace(/(^, |--|-$)/g, ""),
              "TanggalAwalISO": tanggalAwalISO || "",
              "User Approve": d.approvedBy || "-"
            });
          }
        });

        console.log("Counts:", {
          shiftCount: shiftData.length,
          lemburCount: lemburData.length,
          gantiHariCount: gantiHariData.length
        });

        if (shiftData.length === 0 && lemburData.length === 0 && gantiHariData.length === 0) {
          loadingOverlay.classList.remove('active');
          alert("‚ùå Tidak ada data approved pada periode tersebut.");
          return;
        }

        // ===== Generate Excel =====
        const wb = XLSX.utils.book_new();

        if (shiftData.length > 0) {
          const ws1 = XLSX.utils.json_to_sheet(shiftData);
          XLSX.utils.book_append_sheet(wb, ws1, "ShiftData");
        }
        if (lemburData.length > 0) {
          const ws2 = XLSX.utils.json_to_sheet(lemburData);
          XLSX.utils.book_append_sheet(wb, ws2, "LemburData");
        }
        if (gantiHariData.length > 0) {
          const ws3 = XLSX.utils.json_to_sheet(gantiHariData);
          XLSX.utils.book_append_sheet(wb, ws3, "GantiHariData");
        }

        XLSX.writeFile(wb, `approved_data_${startISO}_to_${endISO}.xlsx`);
        
        loadingOverlay.classList.remove('active');
        alert("‚úÖ File Excel berhasil didownload!");
        
      } catch (err) {
        console.error("Error saat proses download:", err);
        loadingOverlay.classList.remove('active');
        alert("‚ùå Terjadi error saat menyiapkan file. Cek console untuk detail.");
      }
    };
  </script>
</body>
</html>