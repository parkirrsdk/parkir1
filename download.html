<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Download Excel Approve</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Download Data Approved</h1>
    <label>Tanggal Mulai:
      <input type="date" id="filterStart">
    </label>
    <label>Tanggal Sampai:
      <input type="date" id="filterEnd">
    </label>
    <button id="downloadExcel">Download Excel</button>
    <br><br>
    <a href="form.html">Input Data</a> |
    <a href="list-approve.html">List Approve</a> |
    <a href="list-data.html">List Data</a>
  </div>

  <script type="module">">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAT5F4_ZJr_kj0TaUM_0wwwknv3bZwDaog",
      authDomain: "shift-app-b73fd.firebaseapp.com",
      projectId: "shift-app-b73fd",
      storageBucket: "shift-app-b73fd.firebasestorage.app",
      messagingSenderId: "408848137650",
      appId: "1:408848137650:web:0ec055ed4d7524584cb8ab"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function downloadExcel() {
      const workbook = new ExcelJS.Workbook();

      // ------------------- SHEET SHIFT/OFF -------------------
      const sheetShift = workbook.addWorksheet("Tukar Shift/Off");
      sheetShift.addRow([
        "No", "Nama", "Jabatan", "Shift Dari", "Shift Menjadi", "Tukar Off",
        "Tanggal", "Status Approve", "Status Reject", "Reason",
        "User Approve", "Tanggal Approve"
      ]);

      const shiftSnap = await getDocs(collection(db, "shiftData"));
      let i = 1;
      shiftSnap.forEach(doc => {
        const d = doc.data();
        sheetShift.addRow([
          i++,
          d.nama,
          d.jabatan,
          d.shift_dari || "-",
          d.shift_menjadi || "-",
          d.tukar_off || "-",
          `${d.hari || ""}, ${d.tanggal || ""}-${d.bulan || ""}-${d.tahun || ""}`,
          d.approve ? "Approved" : "Pending",
          d.reject ? "Rejected" : "-",
          d.reason || "-",
          d.approvedBy || "-",
          d.approveDate || "-"
        ]);
      });

      // ------------------- SHEET GANTI HARI -------------------
      const sheetGantiHari = workbook.addWorksheet("Ganti Hari");
      sheetGantiHari.addRow([
        "No", "Nama", "Jabatan", "Alasan", "Tanggal", "Tanggal Pengganti Hari",
        "Status Approve", "Status Reject", "Reason",
        "User Approve", "Tanggal Approve Leader", "Tanggal Approve Admin"
      ]);

      const gantiHariSnap = await getDocs(collection(db, "gantiHariData"));
      let j = 1;
      gantiHariSnap.forEach(doc => {
        const d = doc.data();
        let approvers = [];
        if (d.leaderApprove && d.leaderBy) approvers.push(d.leaderBy);
        if (d.adminApprove && d.adminBy) approvers.push(d.adminBy);
        const approvedUsers = approvers.length > 0 ? approvers.join(", ") : "-";

        sheetGantiHari.addRow([
          j++,
          d.nama,
          d.jabatan,
          d.dikarenakan,
          `${d.hari_awal || ""}, ${d.tanggal_awal || ""}-${d.bulan_awal || ""}-${d.tahun_awal || ""}`,
          `${d.hari_ganti || ""}, ${d.tanggal_ganti || ""}-${d.bulan_ganti || ""}-${d.tahun_ganti || ""}`,
          d.approve ? "Approved" : "Pending",
          d.reject ? "Rejected" : "-",
          d.reason || "-",
          approvedUsers,
          d.leaderApproveDate || "-",
          d.adminApproveDate || "-"
        ]);
      });

      // ------------------- SHEET LEMBUR -------------------
      const sheetLembur = workbook.addWorksheet("Lembur");
      sheetLembur.addRow([
        "No", "Nama", "Jabatan", "Shift", "Dilemburkan Oleh", "Tanggal Melemburkan",
        "Status Approve", "Status Reject", "Reason",
        "User Approve", "Tanggal Approve"
      ]);

      const lemburSnap = await getDocs(collection(db, "lemburData"));
      let k = 1;
      lemburSnap.forEach(doc => {
        const d = doc.data();
        sheetLembur.addRow([
          k++,
          d.nama,
          d.jabatan,
          d.shift || "-",
          d.dilemburkan_oleh,
          `${d.hari || ""}, ${d.tanggal || ""}-${d.bulan || ""}-${d.tahun || ""}`,
          d.approve ? "Approved" : "Pending",
          d.reject ? "Rejected" : "-",
          d.reason || "-",
          d.approvedBy || "-",
          d.approveDate || "-"
        ]);
      });

      // ------------------- EXPORT FILE -------------------
      const buffer = await workbook.xlsx.writeBuffer();
      saveAs(new Blob([buffer]), "Data_Shift.xlsx");
    }
  </script>
</body>
</html>
